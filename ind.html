<?php
// index.php â€” Generator + Player with pretty links (no .htaccess)

// Storage file
define('MAP_FILE', __DIR__ . '/map.json');
$map = [];
if (file_exists(MAP_FILE)) {
    $map = json_decode(file_get_contents(MAP_FILE), true) ?: [];
}

// Utility: generate short code
function generate_code($length = 8) {
    return substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, $length);
}

// Detect path
$uri = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);
$parts = explode('/', trim($uri, '/'));

if (count($parts) >= 2 && $parts[0] === 'e') {
    // ================= Player Mode =================
    $code = $parts[1] ?? '';
    if (!isset($map[$code])) {
        http_response_code(404);
        echo "<h1>Video not found</h1>";
        exit;
    }
    $entry = $map[$code];
    ?>
    <!doctype html>
    <html>
    <head>
        <meta charset="utf-8">
        <title><?= htmlspecialchars($entry['title'] ?: 'Player') ?></title>
        <script src="https://cdn.jsdelivr.net/npm/jwplayer@8.32.0/jwplayer.js"></script>
        <style>body { margin:0; background:#000; }</style>
    </head>
    <body>
        <div id="player"></div>
        <script>
        jwplayer("player").setup({
            file: "<?= htmlspecialchars($entry['url']) ?>",
            image: "<?= htmlspecialchars($entry['poster'] ?? '') ?>",
            width: "100%",
            height: "100%",
            aspectratio: "16:9"
        });
        </script>
    </body>
    </html>
    <?php
    exit;
}

// ================= Generator Mode =================

// Handle form submission
$generated_url = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['video_url'])) {
    $url = trim($_POST['video_url']);
    $code = generate_code();
    $map[$code] = [
        'url' => $url,
        'title' => $_POST['title'] ?? '',
        'poster' => $_POST['poster'] ?? '',
        'created_at' => date('c')
    ];
    file_put_contents(MAP_FILE, json_encode($map, JSON_PRETTY_PRINT));
    $base = (isset($_SERVER['HTTPS']) ? 'https://' : 'http://') . $_SERVER['HTTP_HOST'];
    $generated_url = $base . "/e/$code";
}
?>
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Turbo VIPlay Generator</title>
    <style>
        body { font-family: sans-serif; background:#111; color:#eee; padding:20px; }
        input, button { padding:8px; margin:5px; width:100%; max-width:500px; }
        .output { margin-top:20px; padding:10px; background:#222; border-radius:8px; }
    </style>
</head>
<body>
    <h1>Turbo VIPlay Generator</h1>
    <form method="post">
        <input type="text" name="video_url" placeholder="Video URL" required>
        <input type="text" name="title" placeholder="Title (optional)">
        <input type="text" name="poster" placeholder="Poster URL (optional)">
        <button type="submit">Generate</button>
    </form>

    <?php if ($generated_url): ?>
    <div class="output">
        <p><b>Direct link:</b> <a href="<?= htmlspecialchars($generated_url) ?>" target="_blank"><?= htmlspecialchars($generated_url) ?></a></p>
        <p><b>Embed code:</b><br>
        <code>&lt;iframe src="<?= htmlspecialchars($generated_url) ?>" width="640" height="360" frameborder="0" allowfullscreen&gt;&lt;/iframe&gt;</code></p>
    </div>
    <?php endif; ?>
</body>
</html>
